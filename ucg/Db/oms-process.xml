<?xml version="1.0" encoding="utf-8" ?>
<oms cs-namespace="BusterWood.OpenOms">
  
  <script name="investments" transaction="true">
    <state name="initial">
      <event on="enter market" next="live">
        <do>check restrictions</do>        
        <do>reserve position</do>        
        <do>create execution orders</do>
        <do>send execution orders to EMS</do>
      </event>
      <event on="cancel" next="cancelled"/>
    </state>

    <!-- reached via the exception event -->
    <state name="compliance failed">
      <event on="order cancelled" next="live">
        <do>check restrictions</do>        
        <do>reserve position</do>        
        <do>create execution orders</do>
        <do>send execution orders to EMS</do>
      </event>
    </state>
    
    <!-- reached via the exception event -->
    <state name="locate stock">
      <event on="stock located" next="live">
        <do>check restrictions</do>        
        <do>reserve position</do>        
        <do>create execution orders</do>
        <do>send execution orders to EMS</do>
      </event>
      <event on="order cancelled" next="live">
        <do>check restrictions</do>        
        <do>reserve position</do>        
        <do>create execution orders</do>
        <do>send execution orders to EMS</do>
      </event>
      <event on="end of day" next="trading day ended"/>
    </state>
    
    <!-- reached via the exception event -->
    <state name="execution order creation failure">
      <event on="order cancelled" next="live">
        <do>check restrictions</do>        
        <do>reserve position</do>        
        <do>create execution orders</do>
        <do>send execution orders to EMS</do>
      </event>
      <event on="retry" next="live">
        <do>check restrictions</do>        
        <do>reserve position</do>        
        <do>create execution orders</do>
        <do>send execution orders to EMS</do>
      </event>
      <event on="end of day" next="trading day ended">
        <do>cancel position reservation</do>
      </event>
    </state>
    
    <state name="live">
      <event on="end of day" next="trading day ended">
        <do>withdraw from EMS</do>
        <do>cancel position reservation</do>
      </event>      
      <event on="withdraw" next="not trading">
        <do>withdraw from EMS</do>
      </event>
      <event on="cancel" next="cancelled">
        <do>withdraw from EMS</do>
        <do>cancel position reservation</do>        
      </event>
      <event on="fully booked" next="complete"/>
    </state>

    <state name="not trading">
      <event on="start trading" next="live">
        <do>send execution orders to EMS</do>
      </event>
      <event on="cancel" next="cancelled">
        <do>cancel position reservation</do>
      </event>
      <event on="fully booked" next="complete"/>
    </state>

    <state name="trading day ended">
      <event on="start of day" next="live">
        <do>check restrictions</do>        
        <do>reserve position</do>        
        <do>create execution orders</do>
        <do>send execution orders to EMS</do>
      </event>
      <event on="fully booked" next="complete"/>
      <event on="cancel" next="cancelled"/>
    </state>

    <state name="default" default="true">
      <event on="archvie">
        <do>archive</do>
      </event>
      <event on="exception">
        <do>try to recover</do>
      </event>
    </state>

    <state name="complete" terminal="true"/>
    <state name="cancelled" terminal="true"/>
  </script>


  
  <script name="broker orders" transaction="true">
    <state name="booking">
      <event on="new broker order" next="booking requested">
        <do>save broker order</do>
        <do>fairly allocate</do>
        <do>check details</do> 
        <do>request booking</do>
      </event>
    </state>
    
    <state name="fair allocation failed">
      <event on="retry" next="booking requested">
        <do>fairly allocate</do>
        <do>check details</do> 
        <do>request booking</do>
      </event>
      <event on="cancel" next="cancelled"/>
    </state>
    
    <state name="booking requested">
      <event on="accepted"/>
      <event on="complete" next="complete"/>
      <event on="failed" next="failed"/>      
    </state>
    
    <state name="complete">
      <event on="cancel" next="cancelling">
        <do>request booking cancellation</do>
      </event>
    </state>
    
    <state name="failed">
      <event on="cancel" next="cancelled"/>
      <event on="retry" next="booking requested">
        <do>request booking</do>
      </event>
    </state>
    
    <state name="cancelling">
      <event on="booking cancelled" next="cancelled">
      </event>
    </state>
    
    <state name="cancelled" terminal="true"/>
    
    <state name="default" default="true">
      <event on="archvie">
        <do>archive</do>
      </event>
      <event on="exception">
        <do>try to recover</do>
      </event>
    </state>
  </script>
</oms>
