<?xml version="1.0" encoding="utf-8" ?>
<oms cs-namespace="ucg">
  
  <script name="Enter the market">
    <state name="check compliance">
      <event on="success" next="create execution orders">
        <do>create execution orders</do>
        <do>send execution orders to EMS</do>
      </event>
      <event on="success with stock locations" next="locate stock"/>
      <event on="failure"/>
    </state>
    <state name="locate stock">
      <event on="stock located" next="check compliance"/>
      <event on="order cancelled" next="check compliance" />      
    </state>
    <state name="execution order creation failure">
      <event on="order cancelled" next="check compliance" />
    </state>    
  </script>

  <script name="end of day">
    <state name ="withdraw execution orders">
      <event on="withdrawn from EMS">
        <do>cancel position reservation</do>
      </event>
    </state>
  </script>

  <script name="broker order booking">    
    <state name="booking">
      <event on="new broker order" next="booking requested">
        <do>save broker order</do>
        <do>fairly allocate</do>
        <do>check details</do> 
        <do>request booking</do>
      </event>
    </state>
    <state name="fair allocation failed">
      <event on="retry" next="booking requested">
        <do>fairly allocate</do>
        <do>check details</do> 
        <do>request booking</do>
      </event>
      <event on="cancel" next="cancelled"/>
    </state>
    <state name="booking requested">
      <event on="accepted"/>
      <event on="complete" next="complete"/>
      <event on="failed" next="failed"/>      
    </state>
    <state name="complete">
      <event on="cancel" next="cancelling">
        <do>request booking cancellation</do>
      </event>
    </state>
    <state name="failed">
      <event on="cancel" next="cancelled"/>
      <event on="retry" next="booking requested">
        <do>request booking</do>
      </event>
    </state>
    <state name="cancelling">
      <event on="booking cancelled" next="cancelled">
      </event>
    </state>
    <state name="cancelled" terminal="true"/>
  </script>
</oms>
